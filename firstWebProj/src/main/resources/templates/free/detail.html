<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>ê²Œì‹œê¸€ ìƒì„¸</title>
    <link rel="stylesheet" href="/detail.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

</head>
<body>
<h1 class="site-title">ğŸ§ ë®¤ì§ í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ê³µìœ  ì‚¬ì´íŠ¸ ğŸ§</h1>

<div class="post-card">
    <p class="post-title">TITLE &nbsp;&nbsp;<span th:text="${post.title}">TITLE</span></p>
    <p>DATE &nbsp;&nbsp;&nbsp;&nbsp;<span th:text="${#temporals.format(post.createAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</span></p>
    <p><strong>NAME &nbsp;&nbsp;</strong> <span th:text="${post.author.username}">ì‘ì„±ì</span></p>
    <p class="post-content">
        <span th:text="${post.content}">ë‚´ìš©</span>
    </p>

    <p>FILE</p>
    <ul>
<!--    íŒŒì¼ì˜ ìœ ë®¤: ìœ  >>-->
        <li th:each="file : ${uploadedFiles}">
            <span th:text="${file}"></span>
            <audio controls>
                <source th:src="@{/play/{filename}(filename=${file})}" type="audio/mpeg" />
                Your browser does not support the audio element.
            </audio>
        </li>
<!--    íŒŒì¼ì˜ ìœ ë¬´: ë¬´ >>-->
        <p class="no-files-message" th:if="${#lists.isEmpty(uploadedFiles)}">ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</p>
    </ul>
</div>

<div class="post-card" th:if="${loggedInUser != null}">
    <div th:if="${post.author != null and loggedInUser.id == post.author.id}">
        <a class="btn btn-warning" th:href="@{/free/update/{id}(id=${post.id})}">ìˆ˜ì •</a>
        <a class="btn btn-danger" th:href="@{/free/delete/{id}(id=${post.id})}"
           onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ</a>
    </div>
    <div class="btn-danger-transparent"
         th:if="${loggedInUser.role != null and loggedInUser.role.name() == 'ADMIN'}">
        <a th:href="@{/free/delete/{id}(id=${post.id})}" onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">ì‚­ì œ (Admin)</a>
    </div>
</div>

<div class="post-card">
    <h4 class="comment-title" th:text="'ëŒ“ê¸€ ' + ${#lists.size(comments)}"></h4>
    <ul>
        <!-- ëŒ“ê¸€ì´ ì—†ì„ ë•Œ ë¬¸êµ¬ ì¶”ê°€ -->
        <p class="comment-card empty" th:if="${#lists.isEmpty(comments)}">ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <div th:each="comment : ${comments}">
            <div class="comment-card">
                <p class="comment-author">â™¬ <span th:text="${comment.author.username}">ì‘ì„±ì</span></p>
                <p class="comment-content" th:text="${comment.comment}"></p>
                <small class="comment-date" th:text="${#temporals.format(comment.createAt, 'yyyy-MM-dd HH:mm')}">ì‘ì„±ì¼</small>

                <!-- user: ìˆ˜ì • / ì‚­ì œ ë²„íŠ¼ ë³´ì„ -->
                <div class="comment-actions"
                     th:if="${loggedInUser != null and loggedInUser.id == post.author.id}">
                    <div th:if="${loggedInUser.id == comment.author.id}">
                        <button type="button" class="btn btn-warning"
                                th:onclick="'editComment(event, ' + ${comment.id} + ')'">ìˆ˜ì •</button>
                        <form th:action="@{/comment/delete/{id}(id=${comment.id})}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                        </form>
                    </div>
                    <!-- admin: ì‚­ì œ ë²„íŠ¼ë§Œ -->
                    <div th:if="${loggedInUser.role != null and loggedInUser.role.name() == 'ADMIN'}">
                        <form th:action="@{/comment/delete/{id}(id=${comment.id})}" method="post" style="display:inline;">
                            <button type="submit" class="btn btn-danger" onclick="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ì‚­ì œ</button>
                        </form>
                    </div>
                </div>

                <div th:id="'edit-comment-' + ${comment.id}" style="display:none;">
                    <form th:action="@{/comment/edit/{commentId}(commentId=${comment.id})}" method="post" class="edits-comment-form">
<!--                        <textarea name="comment" id="comment-text-${comment.id}" rows="4" required th:text="${comment.comment}"></textarea>-->
                        <textarea name="newComment" rows="2" required th:text="${comment.comment}"></textarea>
                        <button type="submit" class="btn btn-warning">ìˆ˜ì •</button>
                        <button type="button" class="btn btn-danger" th:onclick="'cancelEdit(' + ${comment.id} + ')'">ì·¨ì†Œ</button>
                    </form>
                </div>

                <!--ëŒ€ëŒ“ê¸€ í¼-->
                <!--ë²„íŠ¼-->
                <div class="reply-actions">
                    <button type="button" class="btn btn-primary"
                            th:onclick="'toggleReplyForm(event, ' + ${comment.id} + ')'">ë‹µê¸€</button>
                </div>
                <!-- ëŒ€ëŒ“ê¸€ ì‘ì„±í¼ -->
                <div th:id="'reply-comment-' + ${comment.id}" style="display:none;">
                    <form th:action="@{/comment/reply/{parentId}(parentId=${comment.id})}" method="post">
                        <input type="hidden" name="freeId" th:value="${post.id}"/>
                        <textarea name="comment" rows="2" required placeholder="ì—¬ê¸°ì— ë‹µê¸€ì„ ì‘ì„±í•˜ì„¸ìš”"></textarea>
                        <div class="reply-actions">
                            <button type="submit" class="btn btn-primary">ì…ë ¥</button>
                            <button type="button" class="btn btn-secondary" th:onclick="'toggleReplyForm(' + ${comment.id} + ')'">ì·¨ì†Œ</button>
                        </div>
                    </form>
                </div>

                <!--ëŒ€ëŒ“ê¸€ í‘œì‹œ-->
                <ul th:if="${not #lists.isEmpty(comment.replies)}">
                    <li th:each="reply : ${comment.replies}">
                        <div class="reply-card">
                            <span class="reply-arrow">â†ª</span>
                            <p class="reply-author">â™ª <span th:text="${reply.author != null ? reply.author.username : 'ì‘ì„±ì ì—†ìŒ'}">ë‹µê¸€ ì‘ì„±ì</span></p>
                            <p class="reply-content" th:text="${reply.content}"></p>
                            <small class="reply-date" th:text="${#temporals.format(reply.createAt, 'yyyy-MM-dd HH:mm')}">ë‹µê¸€ ì‘ì„±ì¼</small>
                        </div>
                        <div style="text-align: right;">
                            <!-- ì‘ì„±ì: ì‚­ì œ ë²„íŠ¼ -->
                            <div th:if="${reply.author.username == loggedInUser.username}">
                                <form th:action="@{/comment/delete/reply/{id}(id=${reply.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ë‹µê¸€ ì‚­ì œ</button>
                                </form>
                            </div>
                            <!-- ê´€ë¦¬ì: ì‚­ì œ ë²„íŠ¼ -->
                            <div th:if="${loggedInUser.role != null and loggedInUser.role.name() == 'ADMIN'}">
                                <form th:action="@{/comment/delete/reply/{id}(id=${reply.id})}" method="post" style="display:inline;">
                                    <button type="submit" class="btn btn-danger" onclick="return confirm('ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">ë‹µê¸€ ì‚­ì œ (Admin)</button>
                                </form>
                            </div>
                        </div>
                    </li>
                </ul>
                <!-- ëŒ€ëŒ“ê¸€ì´ ì—†ì„ ë•Œì˜ êµ¬ì¡°ë¥¼ ê°ì¶”ê³ , ëŒ€ëŒ“ê¸€ì„ ì¶”ê°€í•  ë²„íŠ¼ê³¼ í¼ë§Œ ë³´ì—¬ì¤Œ -->
                <div th:if="${#lists.isEmpty(comment.replies)}">
                    <p style="display:none;">ë‹µê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </ul>
</div>

<div class="post-card">
<!--th:íƒ€ì„ë¦¬í”„ @&-->
    <form th:action="@{/comment/create/{id}(id=${post.id})}" method="post" class="comment-form">
<!--    Controller ì—ì„œ SiteUser loggedInUser ë¡œ ë°›ì•„ì•¼ í•˜ê¸° ë•Œë¬¸ì— username ì„ hidden ìœ¼ë¡œ ë°›ê¸°-->
        <input type="hidden" name="username" th:value="${loggedInUser.username}">
        <div class="textarea-container">
            <textarea name="comment" id="comment" rows="2" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”" required></textarea>
            <button type="submit" class="btn btn-register">ë“±ë¡</button>
        </div>
    </form>
</div>

<div class="post-card text-center">
    <a style="text-align: center;" href="/free/list">ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
</div>

<script>
    // ìˆ˜ì • í¼ í‘œì‹œ
    function editComment(event, commentId) {
        event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
        const editForm = document.getElementById(`edit-comment-${commentId}`);

        if (editForm) {
            editForm.style.display = 'block'; // ìˆ˜ì • í¼ì„ ë³´ì´ê²Œ í•¨
            console.log("ìˆ˜ì • í¼ì´ ì„±ê³µì ìœ¼ë¡œ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
            console.error("ìˆ˜ì • í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID:", `edit-comment-${commentId}`);
        }
    }

    // ìˆ˜ì • í¼ ìˆ¨ê¸°ê¸°
    function cancelEdit(commentId) {
        // textarea ë‚´ìš© ì´ˆê¸°í™”
        document.getElementById("edit-comment-" + commentId).style.display = "none";
        // ë‚´ìš© ì´ˆê¸°í™”
        document.getElementById("comment-text-" + commentId).value = "";
    }

    // ëŒ€ëŒ“ê¸€ ìˆ˜ì •í¼
    function toggleReplyForm(event, commentId) {
        event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
        const replyForm = document.getElementById(`reply-comment-${commentId}`);

        if (replyForm) {
            replyForm.style.display = (replyForm.style.display === 'none' || replyForm.style.display === '') ? 'block' : 'none';
        } else {
            console.error("ë‹µê¸€ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID:", `reply-comment-${commentId}`);
        }
    }
</script>

</body>
</html>